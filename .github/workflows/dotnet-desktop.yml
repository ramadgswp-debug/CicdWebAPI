name: .NET 8 WebAPI CI/CD to IIS (Windows 11)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: windows-latest

    steps:
      # 1Ô∏è‚É£ Checkout the code
      - name: Checkout code
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Setup .NET 8 SDK
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 8.0.x

      # 3Ô∏è‚É£ Restore dependencies
      - name: Restore dependencies
        run: dotnet restore

      # 4Ô∏è‚É£ Build the project
      - name: Build
        run: dotnet build --configuration Release --no-restore

      # 5Ô∏è‚É£ Run unit tests
      - name: Test
        run: dotnet test --no-build --verbosity normal

      # 6Ô∏è‚É£ Publish the project
      - name: Publish
        run: dotnet publish -c Release -o ./publish

      # 7Ô∏è‚É£ List published files (optional, for debugging)
      - name: List published files
        shell: pwsh
        run: Get-ChildItem -Path "$PWD\publish" -Recurse

      # 8Ô∏è‚É£ Stop IIS App Pool on the remote server
      - name: Stop IIS App Pool
        shell: pwsh
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} `
            "Import-Module WebAdministration; Stop-WebAppPool -Name 'MyWebAPIAppPool'"

      # 9Ô∏è‚É£ Remove old files on the remote server
      - name: Clean IIS directory
        shell: pwsh
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} `
            "Remove-Item -Path 'C:\inetpub\wwwroot\MyWebAPI\*' -Recurse -Force"

      # üîü Copy published files via SCP
      - name: Copy published files
        shell: pwsh
        run: |
          scp -r ./publish/* ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:"C:/inetpub/wwwroot/MyWebAPI/"

      # 1Ô∏è‚É£1Ô∏è‚É£ Start IIS App Pool
      - name: Start IIS App Pool
        shell: pwsh
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} `
            "Import-Module WebAdministration; Start-WebAppPool -Name 'MyWebAPIAppPool'"
