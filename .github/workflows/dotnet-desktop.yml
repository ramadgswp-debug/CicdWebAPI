name: .NET 8 WebAPI CI/CD to IIS

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: windows-latest

    steps:
      # 1Ô∏è‚É£ Checkout the code
      - name: Checkout code
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Setup .NET 10 SDK
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
           dotnet-version: 10.0.x

      # 3Ô∏è‚É£ Restore dependencies
      - name: Restore dependencies
        run: dotnet restore

      # 4Ô∏è‚É£ Build the project
      - name: Build
        run: dotnet build --configuration Release --no-restore

      # 5Ô∏è‚É£ Run unit tests
      - name: Test
        run: dotnet test --no-build --verbosity normal

      # 6Ô∏è‚É£ Publish the project
      - name: Publish
        run: dotnet publish -c Release -o ./publish

      # 7Ô∏è‚É£ List published files (optional, PowerShell syntax)
      - name: List published files
        shell: pwsh
        run: Get-ChildItem -Path "$PWD\publish" -Recurse

      # 8Ô∏è‚É£ Stop IIS App Pool and remove old files
      - name: Prepare IIS
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASS }}
          script: |
            Import-Module WebAdministration
            Stop-WebAppPool -Name 'MyWebAPIAppPool'
            Remove-Item -Path 'C:\inetpub\wwwroot\MyWebAPI\*' -Recurse -Force

      # 9Ô∏è‚É£ Copy published files to Windows server
      - name: Copy published files
        uses: appleboy/scp-action@v0.1.6
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASS }}
          source: "./publish/*"
          target: "C:/inetpub/wwwroot/MyWebAPI"

      # üîü Start IIS App Pool
      - name: Restart App Pool
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASS }}
          script: |
            Import-Module WebAdministration
            Start-WebAppPool -Name 'MyWebAPIAppPool'
